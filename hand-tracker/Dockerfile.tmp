FROM ghcr.io/luxonis/robothub-app:2022.274.1807-ros2noetic-custom-dev

# setup timezone

# ENV ROS_DISTRO galactic
RUN apt-get update && \
    apt-get install -q -y --no-install-recommends ca-certificates ros-${ROS_DISTRO}-cv-bridge ros-${ROS_DISTRO}-vision-msgs libboost-python-dev 

RUN apt-get install -y \
  build-essential \
  cmake \
  git 
#   python3-colcon-common-extensions \
#   python3-pip \
#   python3-rosdep \
#   python3-setuptools \
#   python

    # rm -rf /var/lib/apt/lists/*

WORKDIR /home
RUN mkdir -p dai_ws/src && cd dai_ws/src && git clone --depth=1 --branch hand-landmark  https://github.com/luxonis/depthai-ros.git
RUN pwd
RUN cd dai_ws && /bin/bash -c "source /opt/ros/${ROS_DISTRO}/setup.bash &&\ 
                    catkin_make --only-pkg-with-deps depthai_ros_msgs"


ADD ./docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh
ADD robothub-sdk/robothub_sdk/src/robothub_sdk /lib/robothub_sdk

ADD models models
ADD custom_models custom_models

# install packages
# RUN apt update && apt install -q -y --no-install-recommends \
#     python3-pip \
#     && rm -rf /var/lib/apt/lists/*

RUN rm -rf /var/lib/apt/lists/*
# RUN apt update && apt install -q -y --no-install-recommends \
#     python3-dev \
#     gcc \
#     libc-dev \
#     iputils-ping 

ADD requirements.txt requirements.txt
RUN python3 -m pip install -r requirements.txt

ADD FPS.py FPS.py
ADD HandTrackerBpfEdge.py HandTrackerBpfEdge.py
ADD HandTrackerRenderer.py HandTrackerRenderer.py
ADD mediapipe_utils.py mediapipe_utils.py
ADD template_manager_script_bpf_solo.py template_manager_script_bpf_solo.py
ADD template_manager_script_bpf_duo.py template_manager_script_bpf_duo.py 

# Ad as separate layer, since it changes often
ENTRYPOINT ["docker-entrypoint.sh"]
ARG FILE=app.py
ADD $FILE run.py    

# CMD ["python3", "run.py"]

LABEL com.luxonis.config=dmVyc2lvbjogJzEuMS4wJyAjIHJlcXVpcmVkCmltYWdlOiBsdXhvbmlzL2hhbmQtdHJhY2tlciAjIHJlcXVpcmVkCm5hbWU6IFJvYm90SHViIGhhbmQgdHJhY2tlciAjIHJlcXVpcmVkCmRlc2NyaXB0aW9uOiBSdW5zIEhhbmQgRGV0ZWN0aW9uIG1vZGVsIGFuZCBzZW5kcyBJbWFnZSB0byBIdWIgb24gbWFraW5nIGZpc3QuICMgcmVxdWlyZWQKbGFuZ3VhZ2U6IHB5dGhvbiAjIG9wdGlvbmFsICh2aXNpYmxlIGluIFVJKQp1cmw6IGh0dHBzOi8vZ2l0aHViLmNvbS9sdXhvbmlzL3JvYm90aHViLWFwcHMKcHJlcmVxdWlzaXRlczogIyBUaGUgZm9sbG93aW5nIGlzIGp1c3QgYW4gZXhhbXBsZSwgaWdub3JlZCBieSBvdXIgc2VydmVyIGF0IHRoZSBtb21lbnQKICBzdGVyZW9EZXB0aDogVHJ1ZSAjIE9wdGlvbmFsIC0gdHJ1ZSAtPiBvbmx5IE9BSy1EIGNhbWVyYXMgYXJlIGFsbG93ZWQKICBjaGlwc2V0OiBbJ215cmlhZCcsICdrZWVtYmF5J10gIyBPcHRpb25hbCAtIGFsbG93cyBmaWx0ZXJpbmcgYnkgZ2VuZXJhdGlvbgpjb25maWd1cmF0aW9uOgogIGxhbmRtYXJrX21vZGVsOgogICAgbGFiZWw6ICdIYW5kIExhbmRtYXJrIG1vZGVsJwogICAgdHlwZTogJ2Nob2ljZScKICAgIGRlZmF1bHQ6IGxpdGUKICAgIG9wdGlvbnM6CiAgICAgIC0KICAgICAgICBrZXk6IGxpdGUKICAgICAgICBsYWJlbDogJ0xBTkRNQVJLX01PREVMX0xJVEUnCiAgICAgIC0KICAgICAgICBrZXk6IGZ1bGwKICAgICAgICBsYWJlbDogJ0xBTkRNQVJLX01PREVMX0ZVTEwnCiAgICAgIC0KICAgICAgICBrZXk6IHNwYXJzZQogICAgICAgIGxhYmVsOiAnTEFORE1BUktfTU9ERUxfU1BBUlNFJwogIHVzZV93b3JsZF9sYW5kbWFya3M6CiAgICBsYWJlbDogJ3VzZV93b3JsZF9sYW5kbWFya3MnCiAgICB0eXBlOiAnYm9vbGVhbicKICAgIGRlZmF1bHQ6IGZhbHNlCiAgdXNlX2dlc3R1cmU6CiAgICBsYWJlbDogJ3VzZV9nZXN0dXJlJwogICAgdHlwZTogJ2Jvb2xlYW4nCiAgICBkZWZhdWx0OiB0cnVlCiAgYWxsX2hhbmRzOgogICAgbGFiZWw6ICdhbGxfaGFuZHMnCiAgICB0eXBlOiAnYm9vbGVhbicKICAgIGRlZmF1bHQ6IHRydWUKICBzaW5nbGVfaGFuZF90b2xlcmFuY2VfdGhyZXNoOgogICAgbGFiZWw6ICdzaW5nbGVfaGFuZF90b2xlcmFuY2VfdGhyZXNoJwogICAgdHlwZTogJ251bS1yYW5nZScKICAgIHN0ZXA6IDMKICAgIG1pbjogNQogICAgbWF4OiAzMAogICAgZGVmYXVsdDogMTAgIyAKICBsbV9uYl90aHJlYWRzOgogICAgbGFiZWw6ICdsbV9uYl90aHJlYWRzJwogICAgdHlwZTogJ251bS1yYW5nZScKICAgIHN0ZXA6IDEKICAgIG1pbjogMQogICAgbWF4OiAyCiAgICBkZWZhdWx0OiAyICMgMiB0aHJlYWRzCiAgdHJhY2U6CiAgICBsYWJlbDogJ3RyYWNlJwogICAgdHlwZTogJ251bS1yYW5nZScKICAgIHN0ZXA6IDEKICAgIG1pbjogMAogICAgbWF4OiAzCiAgICBkZWZhdWx0OiAwICAjIE5vIFRyYWNlCgogIHJlc29sdXRpb246CiAgICBsYWJlbDogJ3Jlc29sdXRpb24nCiAgICB0eXBlOiAnY2hvaWNlJwogICAgZGVmYXVsdDogZnVsbAogICAgb3B0aW9uczoKICAgICAgLQogICAgICAgIGtleTogZnVsbAogICAgICAgIGxhYmVsOiAnMTA4MF9QX1JFUycKICAgICAgLQogICAgICAgIGtleTogdWx0cmEKICAgICAgICBsYWJlbDogJzRLX1JFUycKICBmcHM6CiAgICBsYWJlbDogJ2ZwcycKICAgIHR5cGU6ICdudW0tcmFuZ2UnCiAgICBzdGVwOiAzCiAgICBtaW46IDAKICAgIG1heDogNDAKICAgIGRlZmF1bHQ6IDMwIAogIHh5ejoKICAgIGxhYmVsOiAneHl6JwogICAgdHlwZTogJ2Jvb2xlYW4nCiAgICBkZWZhdWx0OiB0cnVlCiAgaW50ZXJuYWxfZnJhbWVfaGVpZ2h0OgogICAgbGFiZWw6ICdpbnRlcm5hbF9mcmFtZV9oZWlnaHQnCiAgICB0eXBlOiAnbnVtLXJhbmdlJwogICAgc3RlcDogNjQwCiAgICBtaW46IDY0MAogICAgbWF4OiAxMjgwCiAgICBkZWZhdWx0OiA2NDAgCg==